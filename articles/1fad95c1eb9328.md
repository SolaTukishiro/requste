---
title: "Laravelで案件編集の認可をPolicyに切り出して、Controllerをスッキリさせるまでの試行錯誤"
emoji: "🔐"
type: "tech"
topics: ["Laravel", "Policy", "認可", "初心者", "個人開発"]
published: true
---

## はじめに
Laravelで個人開発（Requste）を進める中で、案件編集ページを作っているときに  
毎回こういうチェックを書く必要が出てきました。

> 「この案件はログイン中ユーザーのものか？」

つまり  
`$request->client_id` と `auth()->id()` の一致判定です

最初は Controller に直書きしていたのですが、detail / edit / update などで何度も出てきて  
「これ、毎回書くのだるい…」となり、認可処理を切り出すことにしました。

この記事では、今日実際にやった  
**「Policyに移そうとして詰まったところ 」** までを記録します。

## やりたかったこと

やりたいのはシンプルで、  

- `request->client_id` と `auth()->id()` が一致するならOK
- 一致しないなら `abort(403)`

この判断を どこかにまとめたいという話です。

### まず Controller に関数として切り出した

最初は Controller にこういうメソッドを作りました。

```php
public function authClientId(RequestModel $request): bool
{
    return $request->client_id == auth()->id();
}
```

これで Controller の中では  
「判定ロジック」を直接書かずに済むようになりました。

ただ、ここで疑問が出ました。

> 「この**認可**ってControllerに置き続けていいの？」

### Policyという仕組みを知って「移そう」とした

調べてみると Laravel には **Policy** という仕組みがあるらしく、  
「モデルに対する操作権限をまとめる場所」として紹介されていました。

そこで、認可判定を **RequestPolicy** に移そうとしました。

### 詰まったポイント：`RequestPolicy::class->...` が動かない

Controller側で、こう書いてしまいました。

```php
if(RequestPolicy::class->authClientId($request)){
    abort(403);
}
```

すると、

> Call to a member function authClientId() on string

というエラー。

### 原因：`::class` は「クラス名の文字列」を返す

`RequestPolicy::class` は クラスそのものではなく、  
「`App\Policies\RequestPolicy` みたいな文字列」を返します。

なので、

> `->authClientId()` のように **インスタンスのメソッド** を呼ぶことはできません。

つまり **「stringに対してメソッド呼んでる」** 状態になっていて、エラーになります。

### ついでにもう1つ：abort条件も逆になりがち

今回の判定は「一致したらOK」なので、

- 一致したら abort ではなく通す
- 一致しなかったら abort

です。

つまり `abort(403)` は基本 否定側で書くのが安全だと感じました。

### 現時点で記載したコード
現状調べた範囲では、`authorize()` を使う方法が推奨されていることは理解していますが、  
今回は挙動を明確に理解するため、Policy を直接呼び出す形で記述することにしました。

```php
$policy = new RequestPolicy();
if ($policy->authClientId($request)) {
    abort(403);
}
```
のように、Policyクラスを直接生成して認可判定を行う形で実装しています。
## 今回の到達点

今回の開発では、

- 「認可判定をまとめたい」という目的は明確になった
- 「Policyという置き場所がある」ことも分かった
- ただし Laravel公式のPolicy連携（authorize/can）まではまだ使っていない
- Policyクラスを作って 呼び出し方で詰まった

という状態まで到達しました。

## おわりに

今日は「Policyを完璧に使いこなせた日」ではなく、  
認可ロジックを整理しようとして、Laravelの罠にハマった日でした。  

ただ、`::class` が文字列であることに気づけたのは大きい収穫でした。  
次は、PolicyをLaravelの認可機構として正しく接続する（authorize/can）ところまで進めてみようと思います。  

初学者が調べながらまとめた内容のため、  
もし誤りやより良い書き方があればご教授いただけると嬉しいです。  