---
title: "Laravelで案件作成機能を実装して、route名・Request・タイムスタンプを理解する"
emoji: "✒️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["laravel", "php", "個人開発", "Requste"]
published: true
---
## はじめに
Laravelで個人開発を進める中で、  
**「クライアントが案件を作成できる機能」**
を実装しました。

単純なCRUDのように見えて

- route名の理解
- Controllerの責務
- Requestの正体

など、詰まりポイントが一気に出てきたので、  
今後の自分のためにも記録してまとめます。

## 今日作ったもの
今回実装したのは以下の流れです。

- クライアントユーザーのみアクセス可能
- 案件作成画面(form)
- 案件をDBに登録
- 案件一覧にリダイレクト

MVCで言うと、

- Route：URLとControllerの紐付け
- Controller：入力チェックと保存処理
- Model：DBとのやりとり
- View：フォーム画面

と言ったLaravelの基本王道構成です。

### ルーティング処理(今回最初の山場)
コードを書き始めた時は以下のようなコードでした

```php
Route::middleware(['auth','role:client'])->prefix('client')->name('client.')->group(function () {
    Route::get('/requests', [RequestController::class, 'index'])->name('requests.index');
    Route::get('/requests/create', [RequestController::class, 'create'])->name('requests.store');
    Route::post('/requests/create', [RequestController::class, 'create'])->name('requests.store');
    Route::post('/requests', [RequestController::class, 'store'])->name('requests.store');
});
```
最初はこのコードでうまくいくと思っていたが、うまくいかず悪戦苦闘  
色々調べてみるとおかしいことに気づく...

```php
    Route::get('/requests/create', [RequestController::class, 'create'])->name('requests.store');
    Route::post('/requests/create', [RequestController::class, 'create'])->name('requests.store');
```
途中でname()の中身が被ってしまっている...  
これに気づくまで結構時間がかかってしまった。  

その後に
```php
Route::middleware(['auth','role:client'])->prefix('client')->name('client.')->group(function () {
    Route::get('/requests', [RequestController::class, 'index'])->name('requests.index');

    Route::get('/requests/create', [RequestController::class, 'create'])->name('requests.create');

    Route::post('/requests', [RequestController::class, 'store'])->name('requests.store');
});
```
のように変更し問題なく動作した。

今回の実装で理解したこと

- route('client.requests.store') は URLを見ていない
- **Laravel内部の「名前」** を見てControllerに飛んでいる
```md
route名 = Laravel上のあだ名
URL = 実際のアクセス先
```
を理解したら一気に楽になりました。

### フォームの作成
大きいファイルのため一部分だけ
```php
<form action="{{ route('client.requests.store') }}" method="POST">
    @csrf

    <div>
        <label>タイトル</label>
        <input type="text" name="title">
    </div>

    <div>
        <label>受付状況</label>
        <input type="radio" name="status" value="1" checked> 受付中
        <input type="radio" name="status" value="0"> 停止中
    </div>

    <div>
        <label>説明</label>
        <input type="text" name="description">
    </div>

    <button type="submit">登録する</button>
</form>
```
MVPであるため見た目には拘らず必要最低限の機能だけ実施  
今後作成していき次第外見を意識していきます。

### Controllerのstoreメソッド
ここが一番Laravelぽさを感じたところ
```php
public function store(Request $request)
{
    $request->validate([
        'title' => 'required',
        'description' => 'required',
        'status' => 'required',
    ]);

    RequestModel::create([
        'client_id' => auth()->id(),
        'title' => $request->title,
        'description' => $request->description,
        'status' => $request->status,
    ]);

    return redirect()->route('client.requests.index');
}
```
Request $requestがどこからくるのか  

- Laravelが **自動でDI（依存性注入)** している
- HTTPリクエストそのものが渡されている

auth()->id() とは？

- ログイン中ユーザーのIDを取得
- 今回は「案件の持ち主（client）」として使用

### 今回の実装で詰まったエラー

- RouteNotFoundException
- Call to undefined method Model::validate()
- route名の重複

ほとんどが実装の勘違いからきていた。

### 学んだことまとめ

- route名はURLじゃない
- RequestはLaravelが渡してくれる
- validateはRequestの仕事

### おわりに
CRUD一つ作るだけでも、  
Laravelの思想（MVC・責務分離）がかなり見えてきました。

加えて学んできたことを忘れかけているため、  
今回のエラーは、Laravelの設計思想を理解する良いきっかけになった。

## 次にやること
MVP フェーズ1の予定
```md
・案件詳細ページ
・案件の公開 / 非公開（または受付中 / 終了）
```
